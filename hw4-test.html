#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Mon Feb 21 23:26:29 2022

@author: pritikaparmar
"""

#%%

# !pip install plotly==4.4.1
# !pip uninstall plotly==4.4.1 --yes
!pip install plotly

#%%

import pandas as pd
import plotly.express as px
import numpy as np

# import plotly.graph_objs as go
# from plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot
# init_notebook_mode(connected=True)

df = pd.read_csv("https://raw.githubusercontent.com/smart-stats/ds4bio_book/main/book/assetts/kirby21AllLevels.csv").drop(['Unnamed: 0'], axis = 1)

print(df.tail(10))


#%%

## load in the hierarchy information
url = "https://raw.githubusercontent.com/bcaffo/MRIcloudT1volumetrics/master/inst/extdata/multilevel_lookup_table.txt"
multilevel_lookup = pd.read_csv(url, sep = "\t").drop(['Level5'], axis = 1)
multilevel_lookup = multilevel_lookup.rename(columns = {
    "modify"   : "roi", 
    "modify.1" : "level4",
    "modify.2" : "level3", 
    "modify.3" : "level2",
    "modify.4" : "level1"})
multilevel_lookup = multilevel_lookup[['roi', 'level4', 'level3', 'level2', 'level1']]

## strip white space on level2 data
multilevel_lookup['level2'] = multilevel_lookup['level2'].str.strip()
print(multilevel_lookup.head())

#%%

#Load in Subject Data
subjectData = df.loc[(df.type == 1) & (df.id == 127)]
subjectData = subjectData[['roi', 'volume']]
print(subjectData.tail(10))

## Merge the subject data with the multilevel data
subjectData = pd.merge(subjectData, multilevel_lookup, on = "roi")
subjectData = subjectData.assign(level0 = "ICV")
subjectData = subjectData.assign(comp = subjectData.volume / np.sum(subjectData.volume))
print(subjectData.head())

## Level 1 Data
l1 = subjectData.groupby(['level1', 'level0']).sum().reset_index()
l1 = l1.rename(columns = {'level1' : 'target', 'level0' : 'source'}).drop(['volume'], axis = 1)
print(l1.head())

## Level 2 Data
l2 = subjectData.groupby(['level2','level1']).sum().reset_index()
l2 = l2.rename(columns = {'level2' : 'target', 'level1' : 'source'}).drop(['volume'], axis = 1)
print(l2.head())

## Level 3 Data
l3 = subjectData.groupby(['level3','level2']).sum().reset_index()
l3 = l3.rename(columns = {'level3' : 'target', 'level2' : 'source'}).drop(['volume'], axis = 1)
print(l3.head())

## Level 4 Data
l4 = subjectData.groupby(['level4','level3']).sum().reset_index()
l4 = l4.rename(columns = {'level4' : 'target', 'level3' : 'source'}).drop(['volume'], axis = 1)
print(l4.head())

# ## Level 5 Data
# l5 = subjectData.groupby(['level5','level4']).sum().reset_index()
# l5 = l5.rename(columns = {'level5' : 'target', 'level4' : 'source'}).drop(['volume'], axis = 1)
# print(l5.head())

## Get List of ROIs
rois = pd.concat([subjectData['level0'], subjectData['level1'], subjectData['level2'], subjectData['level3'], subjectData['level4']]).unique().tolist()
print(rois)

## Concatenate Datasets for Level 1 through 4
sankey_dat = pd.concat([l1,l2,l3,l4])

## Add Integers to Regions
sankey_dat['target_idx'] = [rois.index(x) for x in sankey_dat['target']]
sankey_dat['source_idx'] = [rois.index(x) for x in sankey_dat['source']]
print(sankey_dat)

## Plot the Values
import plotly.graph_objs as go
fig = go.Figure(data=[go.Sankey(
    node = dict(
      pad = 15,
      thickness = 40,
      line = dict(color = "black", width = 0.5),
      label = rois,
      color = "blue"
    ),
    link = dict(
      source = sankey_dat['source_idx'],
      target = sankey_dat['target_idx'],
      value = sankey_dat['comp']
  ))])

fig.update_layout(title_text="Brain Composition", height=1000, font_size=10)
fig.show()


#%%



