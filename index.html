<!DOCTYPE>
<HTML>
    <HEAD>
        <TITLE> HW 4 - Pritika Parmar</TITLE>
    </HEAD>
    <BODY>
        <H1>Sankey Diagram</H1>
        
        import pandas as pd
import plotly.express as px
import numpy as np

df = pd.read_csv("https://raw.githubusercontent.com/smart-stats/ds4bio_book/main/book/assetts/kirby21AllLevels.csv").drop(['Unnamed: 0'], axis = 1)

print(df.tail(10))
        
        ## load in the hierarchy information
url = "https://raw.githubusercontent.com/bcaffo/MRIcloudT1volumetrics/master/inst/extdata/multilevel_lookup_table.txt"
multilevel_lookup = pd.read_csv(url, sep = "\t").drop(['Level5'], axis = 1)
multilevel_lookup = multilevel_lookup.rename(columns = {
    "modify"   : "roi", 
    "modify.1" : "level4",
    "modify.2" : "level3", 
    "modify.3" : "level2",
    "modify.4" : "level1"})
multilevel_lookup = multilevel_lookup[['roi', 'level4', 'level3', 'level2', 'level1']]

## strip white space on level2 data
multilevel_lookup['level2'] = multilevel_lookup['level2'].str.strip()
print(multilevel_lookup.head())
        
        #Load in Subject Data
subjectData = df.loc[(df.type == 1) & (df.id == 127)]
subjectData = subjectData[['roi', 'volume']]
#print(subjectData.tail(10))

## Merge the subject data with the multilevel data
subjectData = pd.merge(subjectData, multilevel_lookup, on = "roi")
subjectData = subjectData.assign(level0 = "ICV")
subjectData = subjectData.assign(comp = subjectData.volume / np.sum(subjectData.volume))
#print(subjectData.head())

## Level 1 Data
l1 = subjectData.groupby(['level1', 'level0']).sum().reset_index()
l1 = l1.rename(columns = {'level1' : 'target', 'level0' : 'source'}).drop(['volume'], axis = 1)
#print(l1.head())

## Level 2 Data
l2 = subjectData.groupby(['level2','level1']).sum().reset_index()
l2 = l2.rename(columns = {'level2' : 'target', 'level1' : 'source'}).drop(['volume'], axis = 1)
#print(l2.head())

## Level 3 Data
l3 = subjectData.groupby(['level3','level2']).sum().reset_index()
l3 = l3.rename(columns = {'level3' : 'target', 'level2' : 'source'}).drop(['volume'], axis = 1)
#print(l3.head())

## Level 4 Data
l4 = subjectData.groupby(['level4','level3']).sum().reset_index()
l4 = l4.rename(columns = {'level4' : 'target', 'level3' : 'source'}).drop(['volume'], axis = 1)
#print(l4.head())

# ## Level 5 Data
# l5 = subjectData.groupby(['level5','level4']).sum().reset_index()
# l5 = l5.rename(columns = {'level5' : 'target', 'level4' : 'source'}).drop(['volume'], axis = 1)
# print(l5.head())

## Get List of ROIs
rois = pd.concat([subjectData['level0'], subjectData['level1'], subjectData['level2'], subjectData['level3'], subjectData['level4']]).unique().tolist()
#print(rois)

## Concatenate Datasets for Level 1 through 4
sankey_dat = pd.concat([l1,l2,l3,l4])

## Add Integers to Regions
sankey_dat['target_idx'] = [rois.index(x) for x in sankey_dat['target']]
sankey_dat['source_idx'] = [rois.index(x) for x in sankey_dat['source']]
#print(sankey_dat)

## Plot the Values
import plotly.graph_objs as go
fig = go.Figure(data=[go.Sankey(
    node = dict(
      pad = 15,
      thickness = 40,
      line = dict(color = "black", width = 0.5),
      label = ['ICV', 'Diencephalon_L', 'Diencephalon_R', 'Telencephalon_L', 'Telencephalon_R', 'Metencephalon', 'Myelencephalon', 'CSF', 'Mesencephalon', 'Thalamus_L', 'Thalamus_R', 'BasalForebrain_L', 'BasalForebrain_R', 'CerebralCortex_L', 'CerebralCortex_R', 'Metencephalon_L', 'Metencephalon_R', 'Myelencephalon_L', 'Myelencephalon_R', 'Ventricle', 'Sulcus_L', 'Sulcus_R', 'CerebralNucli_L', 'CerebralNucli_R', 'WhiteMatter_L', 'WhiteMatter_R', 'Mesencephalon_L', 'Mesencephalon_R', 'Insula_L', 'Insula_R', 'Pons_L', 'Pons_R', 'Medulla_L', 'Medulla_R', 'III_ventricle', 'FrontSul_L', 'FrontSul_R', 'CentralSul_L', 'CentralSul_R', 'ParietSul_L', 'ParietSul_R', 'CinguSul_L', 'CinguSul_R', 'OcciptSul_L', 'OcciptSul_R', 'TempSul_L', 'TempSul_R', 'IV_ventricle', 'Frontal_L', 'Frontal_R', 'Parietal_L', 'Parietal_R', 'Temporal_L', 'Temporal_R', 'Occipital_L', 'Occipital_R', 'Limbic_L', 'Limbic_R', 'BasalGang_L', 'BasalGang_R', 'CorpusCallosum_L', 'CorpusCallosum_R', 'InferiorWM_L', 'InferiorWM_R', 'LimbicWM_L', 'LimbicWM_R', 'Cerebellum_R', 'Cerebellum_L', 'SylvianFissureExt_L', 'SylvianFissureExt_R', 'midbrain_L', 'midbrain_R', 'AnteriorWM_L', 'AnteriorWM_R', 'PosteriorWM_L', 'PosteriorWM_R', 'LateralVentricle_L', 'LateralVentricle_R', 'xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx', 'SFG_L', 'SFG_R', 'MFG_L', 'MFG_R', 'RG_L', 'RG_R', 'PoCG_L', 'PoCG_R', 'PrCG_L', 'PrCG_R', 'SPG_L', 'SPG_R', 'SMG_L', 'SMG_R', 'AG_L', 'AG_R', 'PrCu_L', 'PrCu_R', 'STG_L', 'STG_R', 'MTG_L', 'MTG_R', 'ITG_L', 'ITG_R', 'FuG_L', 'FuG_R', 'SOG_L', 'SOG_R', 'MOG_L', 'MOG_R', 'IOG_L', 'IOG_R', 'Cu_L', 'Cu_R', 'LG_L', 'LG_R', 'Amyg_L', 'Amyg_R', 'Hippo_L', 'Hippo_R', 'Caud_L', 'Caud_R', 'Put_L', 'Put_R', 'GP_L', 'GP_R', 'GCC_L', 'GCC_R', 'BCC_L', 'BCC_R', 'SCC_L', 'SCC_R', 'ALIC_L', 'ALIC_R', 'PLIC_L', 'PLIC_R', 'CGC_L', 'CGC_R', 'CGH_L', 'CGH_R', 'Fx/ST_L', 'Fx/ST_R', 'Fx_L', 'Fx_R', 'CerebellumWM_R', 'CerebellumWM_L', 'SylFrontSul_L', 'SylFrontSul_R', 'SylTempSul_L', 'SylTempSul_R', 'SylParieSul_L', 'SylParieSul_R', 'Caudate_tail_L', 'Caudate_tail_R', 'IFG_L', 'IFG_R', 'OG_L', 'OG_R', 'Cingulate_L', 'Cingulate_R', 'ant_DPWM_L', 'ant_DPWM_R', 'post_DPWM_L', 'post_DPWM_R', 'PVA_posterior_L', 'PVA_posterior_R', 'inf_DPWM_L', 'inf_DPWM_R', 'PeripheralParietalWM_L', 'PeripheralParietalWM_R', 'AnteriorLateralVentricle_L', 'PosteriorLateralVentricle_L', 'InferiorLateralVentricle_L', 'AnteriorLateralVentricle_R', 'PosteriorLateralVentricle_R', 'InferiorLateralVentricle_R', 'PVA_anterior_L', 'PVA_anterior_R', 'PeripheralFrontalWM_L', 'PeripheralFrontalWM_R', 'PeripheralTemporalWM_L', 'PeripheralTemporalWM_R', 'PeripheralOccipitalWM_L', 'PeripheralOccipitalWM_R', 'PeripheralCingulateWM_L', 'PeripheralCingulateWM_R'],
      color = "blue"
    ),
    link = dict(
      source = sankey_dat['source_idx'],
      target = sankey_dat['target_idx'],
      value = sankey_dat['comp']
  ))])

fig.update_layout(title_text="Brain Composition", height=2500, font_size=10)
fig.show()
        
        <H2>Opioid Overdose</H2>
        <CODE> CODE </CODE>
    </BODY>
</HTML>
